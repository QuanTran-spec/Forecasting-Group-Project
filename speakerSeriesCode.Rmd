#Speaker Series 

```{r}
library(readxl)
library(fpp2)
library(fpp3)
library(ggplot2)
library(forecast)
library(tidyr)
library(data.table)
library(plyr)
library(xts)
library(vars)
```

Import and clean data 
```{r}
#Read data (make sure it's all in same directory)
onlineTrafficData <- read_xlsx("./onlineTraffic.xlsx")
data <- onlineTrafficData
nrow(data)
head(data)
tail(data)

#Date variable isn't as date type and some values are missing
#create dates from start to end
test <- ddply(data, .(), summarise, Date = seq(as.Date('2014-09-14'), as.Date('2020-08-19'), by = "day"))

#Populate Date column with new, actual dates
data$Date <- test$Date
data
tail(data)
```

Subset 2 years of forecast data 
```{r}
#Save clean data 
full_data <- data
tail(data)
data <- full_data %>% filter(Date > as.Date('2018-08-20'))
head(data)
tail(data)
```

Convert to ts object
```{r}
tsdata <- ts(data, start = c(2018, 233), end = c(2020, 232), frequency = 365)
head(tsdata)
autoplot(tsdata[, c('Page.Loads', 'First.Time.Visits', 'Returning.Visits')], facet = TRUE)
  

#ts object of DV 
plts = tsdata[, 'Page.Loads']
ggtsdisplay(plts)
```

Split train/test for forecasting next 2 weeks (14 days ahead)
```{r}
h = 14
train <- window(tsdata, start = c(2018, 233), end = c(2020, 232 - h), frequency = 365)
test <- window(tsdata, start = c(2020, 232 - h + 1), frequency = 365)
length(test[, 'Page.Loads'])
autoplot(train[,'Page.Loads'])

#DV
pltrain <- train[, 'Page.Loads']
pltest <- test[, 'Page.Loads']
```

Set benchmarks
```{r}
sn <- snaive(pltrain, h=h)
mean <- meanf(pltrain, h=h)
rw <- rwf(pltrain, h=h)
rwd <- rwf(pltrain, drift = T, h=h)

#Check accuracy
accuracy(sn, pltest)
accuracy(mean,pltest)
accuracy(rw,pltest)
accuracy(rwd, pltest)

autoplot(rwd)

#Benchmark MAPE = 24.19 from Random Walk with Drift
```

Vector Autoregression
```{r}
head(train)
#We'll use VAR between Page.Loads, First.Time.Visits and Returning.Visits
#Unique visits is equal to first time visits + returning visits so we can't use it in VAR
#Neither can we run a regression using all three as DV/predictors simultaneously (conceptually wrong)

#Get number of differencing 
VARselect(train[, c(5, 7,8)], lag.max=8,
  type="const")[["selection"]]

#From all the information criteria we need to take 8 lags 

#Get var model with p = 8 
var <- VAR(train[, c(5,7,8)], p=8, type="const")

#Check for residuals autocorrelation
serial.test(var, lags.pt=10, type="PT.asymptotic")

#They aren't white noise but we can't increase the differencing as we run out of df 

#Produce forecast
fcvar <- forecast(var, h) 
autoplot(fcvar)

#Check accuracy
accuracy(fcvar$forecast$Page.Loads, pltest)

#MAPE = 16.13 which is better than benchmarks. 

#Coefficients interpretation problems as all variables influence each other. Research coefs
Bcoef(var)

```

Dynamic Harmonic Regression
```{r}
#Get ndiffs
ndiffs(pltrain, alpha = 0.05, test = 'kpss')

#Difference once and TS display 
ggtsdisplay(diff(pltrain))
```

```{r}
#Get best K value
bestfit <- list(aicc=Inf)
for(K in seq(10, 40, 10)) {
  fit <- auto.arima(pltrain, d = 1, xreg=fourier(pltrain, K=K), seasonal=FALSE, lambda = 'auto')
  if(fit[["aicc"]] < bestfit[["aicc"]]) {
    bestfit <- fit
    bestK <- K
  }
}

bestK
```

```{r}
#Narrow K down to around 10 
for(K in seq(8, 12)) {
  fit <- auto.arima(pltrain, d = 1, xreg=fourier(pltrain, K=K), seasonal=FALSE, lambda = 'auto')
  if(fit[["aicc"]] < bestfit[["aicc"]]) {
    bestfit <- fit
    bestK <- K
  }
}

bestfit
bestK
#Best K = 10
```

```{r}
#Produce forecasts:
fchr <- forecast(bestfit, d = 1, xreg=fourier(pltest, K=bestK, h = h))
autoplot(fchr)
accuracy(fchr, pltest)
checkresiduals(fchr)

#ARIMA(5,1,2) with fourier seasonality (K=10) gives us MAPE = 29.33 Worse than benchmarks


#Harmonic regression may perform poorly because seasonal component is fixed when our data is too long?
#Try forecasting using shorter train set
```

ETS on STL deseasonalized time series
```{r}
#Need to take bigger subset to use STL (more than 2 periods)
subset2 <- full_data %>% filter(Date > as.Date('2017-08-20'))

#Use msts to allow for multiple seasonalities 
subset2 <- msts(subset2, start = c(2017, 233), seasonal.periods = c(7, 365))

train2 <- window(subset2, start = c(2017, 233), end = c(2020, 232 - h))
test2 <- window(subset2, start = c(2020, 232 - h + 1))

fit <- mstl(train2[, 'Page.Loads'])
autoplot(fit)
#Some seasonality isn't captured by mstl 

fcSTL <- forecast(fit, method = 'ets', h = h)
autoplot(fcSTL)
accuracy(fcSTL, test2[, 'Page.Loads'])

#MAPE = 11.27

#Check for better ETS model and t/s.window parameters
```

TBATS model 
```{r}
#Allows for seasonal components to slowly change over time 
fit <- tbats(train2[,'Page.Loads'])
tbfc <- forecast(fit, h = h)

#Plot and accuracy check 
autoplot(tbfc)
#No boxcox transformation, ARMA(5,5), damping. 3 trigonometric terms for weekly seasonality and 7 for yearly seasonality.

accuracy(tbfc, pltest)
# MAPE = 12.37
```

Dynamic Harmonic Regression with weekly & yearly seasonality
```{r}
#Get best K 
windows<- expand.grid(K1 = 2, K2 = seq(6:12), aicc = NA)
#Actually auto.arima only works with K1 = 2 so expand grid is bit redundant.. 

for(row.i in 1:nrow(windows)) {

   K1 <- windows$K1[row.i]
   K2 <- windows$K2[row.i]

   fit <- auto.arima(train2[, 'Page.Loads'], d = 1, seasonal = FALSE, lambda = 'auto', xreg = fourier(train2[,'Page.Loads'], K = c(K1,K2)))
   aicc.i <- fit[['aicc']]    
   windows$aicc[row.i] <- aicc.i
    
}

minaicc<-which.min(windows[,"aicc"])
best<-windows[minaicc,]
best
```

```{r}
fit <- auto.arima(train2[,'Page.Loads'], d = 1, seasonal = FALSE, lambda = 'auto', xreg = fourier(train2[, 'Page.Loads'], K = c(2,8)))

fc <- forecast(fit, xreg = fourier(train2[, 'Page.Loads'], K = c(2,8), h = h))

#Plot and accuracy check
autoplot(fc)
#ARIMA(2,1,5) with multiple seasonality

accuracy(fc, pltest)
#MAPE = 8.87
```

Including covariates in the regression
```{r}


```



#Daily seasonality can't be captured by fourier as frequency = 1? try dummifying working days and including in regression

Try with splines/piecewise


#Objective: Study habits 
  #Understanding study habits of students based on different patterns of website visits
  # -> get most important predictors/ best forecast method for the next 2 weeks based on last 2 years of data


#Time series analysis 


#Different forecasting models and compare 

#Try 
  #Regression
  #Splines 
  #Vector Autoregression













